<script>
  function getQueryParams() {
    const params = new URLSearchParams(window.location.search);
    return {
      productCode: params.get('productCode'),
      voucherCode: params.get('voucherCode'),
      oosLink: params.get('oosLink'),
      debug: params.get('debug') === 'true'
    };
  }

  async function checkStock() {
    const { productCode, voucherCode, oosLink, debug } = getQueryParams();
    const messageEl = document.getElementById('message');
    messageEl.textContent = 'Checking stock availability...';

    if (!productCode || !voucherCode || !oosLink) {
      messageEl.textContent = 'Missing required parameters in URL.';
      return;
    }

    const stockUrl = `https://shop.samsung.com/tokocommercewebservices/v2/hk/products/${encodeURIComponent(productCode)}/`;

    try {
      const response = await fetch(stockUrl, {
        headers: {
          'Accept': 'application/xml'
        }
      });
      const responseText = await response.text();

      console.log("Raw XML response:", responseText);

      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(responseText, "application/xml");

      const stockStatus = xmlDoc.querySelector("stockLevelStatus")?.textContent?.trim();

      console.log("Extracted stockLevelStatus:", stockStatus);

      if (!stockStatus) {
        messageEl.textContent = 'Could not read stock status from response.';
        return;
      }

      messageEl.textContent = `Stock status: ${stockStatus}`;

      if (debug) {
        console.log("Debug mode active â€” no redirect.");
        return;
      }

      if (stockStatus === 'inStock') {
        const cartUrl = `https://shop.samsung.com/tokocommercewebservices/v2/hk/addToCart/multi?redirect=CART&products%5B0%5D.productCode=${encodeURIComponent(productCode)}&&products%5B0%5D.qty=1&newCart=false&voucherCode=${encodeURIComponent(voucherCode)}`;
        window.location.href = cartUrl;
      } else {
        setTimeout(() => {
          window.location.href = oosLink;
        }, 6000);
      }
    } catch (error) {
      messageEl.textContent = 'Error checking stock. See console for details.';
      console.error("Fetch or parse error:", error);
    }
  }

  checkStock();
</script>
